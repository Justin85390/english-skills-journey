<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>English Skills Journey</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    h1 {
      text-align: center;
      font-size: 36px;
      margin-top: 30px;
    }

    p {
      text-align: center;
      font-size: 18px;
      margin-bottom: 20px;
    }

    .container {
      display: none;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }

    .container.active {
      display: block;
    }

    .video-container {
      text-align: center;
      margin: 20px 0;
      border: 2px solid #ccc;
      padding: 10px;
      border-radius: 5px;
      background-color: #fff;
    }

    .video-container iframe {
      width: 100%;
      max-width: 640px;
      height: 360px;
    }

    .form-box {
      width: 100%;
      max-width: 600px;
      margin: 20px auto;
      text-align: center;
      border: 2px solid #ccc;
      padding: 20px;
      background-color: #fff;
    }

    .form-box input,
    .form-box textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      display: block;
      margin: 20px auto;
      padding: 10px 20px;
      font-size: 18px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button.recording {
      background-color: #d9534f;
    }

    img {
      width: 100%;
      max-width: 800px;
      display: block;
      margin: 20px auto;
    }
  </style>
</head>
<body>

  <!-- Page 1 -->
  <div id="page1" class="container active">
    <h1>Welcome to Linguaphone</h1>
    <p>Your journey starts with just a few questions. Press "Ready" to begin.</p>
    <img src="https://justindonlon.com/wp-content/uploads/2024/10/UK-home-page-.png" alt="Image of London Bridge">
    <button onclick="goToPage(2)">Ready</button>
    <button id="recordBtn" onclick="toggleRecording()">Start Recording</button>
    <audio id="audio" controls style="display:none;"></audio>
  </div>

  <!-- Page 2 -->
  <div id="page2" class="container">
    <h1>Your Contact Details</h1>
    <div class="video-container">
      <iframe src="https://www.youtube-nocookie.com/embed/rbpcbMMdbyo" frameborder="0" allowfullscreen></iframe>
    </div>
    <div class="form-box">
      <input type="text" placeholder="First Name">
      <input type="text" placeholder="Last Name">
      <input type="email" placeholder="Email">
      <input type="text" placeholder="Phone Number">
      <button onclick="goToPage(3)">Submit</button>
    </div>
  </div>

  <!-- Page 3 -->
  <div id="page3" class="container">
    <h1>Tell Me More</h1>
    <div class="video-container">
      <iframe src="https://www.youtube-nocookie.com/embed/lnjfpj60-r8" frameborder="0" allowfullscreen></iframe>
    </div>
    <div class="form-box">
      <textarea placeholder="How much time do you have to learn English?" rows="3"></textarea>
      <textarea placeholder="What is your motivation to learn English?" rows="3"></textarea>
      <textarea placeholder="What are some of your interests?" rows="3"></textarea>
      <button onclick="goToPage(4)">Submit</button>
    </div>
  </div>

  <!-- Page 4 -->
  <div id="page4" class="container">
    <h1>Letâ€™s Talk</h1>
    <div class="video-container">
      <iframe src="https://www.youtube-nocookie.com/embed/DXQzd0REkXY" frameborder="0" allowfullscreen></iframe>
    </div>
    <div class="form-box">
      <p>Question: "What is the most difficult thing about learning English?"</p>
      <button onclick="startRecording()">Record your answer</button>
    </div>
  </div>

  <script>
    let mediaRecorder;
    let audioChunks = [];

    function goToPage(pageNumber) {
      document.querySelectorAll('.container').forEach(container => {
        container.classList.remove('active');
      });
      document.getElementById('page' + pageNumber).classList.add('active');
    }

    async function toggleRecording() {
      const recordBtn = document.getElementById('recordBtn');
      if (recordBtn.classList.contains('recording')) {
        stopRecording();
      } else {
        await startRecording();
      }
    }

    async function startRecording() {
      const recordBtn = document.getElementById('recordBtn');
      recordBtn.innerText = "Stop Recording";
      recordBtn.classList.add('recording');
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
          const audioUrl = URL.createObjectURL(audioBlob);
          const audioElement = document.getElementById('audio');
          audioElement.src = audioUrl;
          audioElement.style.display = 'block';
          audioElement.play();
          // Send audioBlob to Google Cloud API for transcription
          await sendToGoogleCloud(audioBlob);
        };

        mediaRecorder.start();
      } catch (err) {
        console.error('Error accessing microphone:', err);
      }
    }

    function stopRecording() {
      mediaRecorder.stop();
      const recordBtn = document.getElementById('recordBtn');
      recordBtn.innerText = "Start Recording";
      recordBtn.classList.remove('recording');
    }

    async function sendToGoogleCloud(audioBlob) {
      const apiKey = window.NEXT_PUBLIC_GOOGLE_CLOUD_API_KEY;  // Use the environment variable
      const url = `https://speech.googleapis.com/v1/speech:recognize?key=${apiKey}`;

      // Convert Blob to Base64
      const reader = new FileReader();
      reader.readAsDataURL(audioBlob);
      reader.onloadend = async () => {
        const base64data = reader.result.split(',')[1];

        // Set up the request payload for Google Cloud Speech-to-Text
        const requestPayload = {
          config: {
            encoding: "MP3",
            sampleRateHertz: 16000,
            languageCode: "en-US"
          },
          audio: {
            content: base64data
          }
        };

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestPayload)
          });

          const data = await response.json();
          if (data && data.results && data.results[0]) {
            const transcription = data.results[0].alternatives[0].transcript;
            console.log("Transcription:", transcription);
            alert(`Transcription: ${transcription}`);
            // Trigger page transition if the transcription is 'ready'
            if (transcription.toLowerCase() === 'ready') {
              goToPage(2);
            }
            // Send transcription to OpenAI API for response
            await sendToOpenAI(transcription);
          } else {
            console.error("No transcription found");
            alert('No transcription found');
          }
        } catch (error) {
          console.error('Error with Google Cloud Speech-to-Text API:', error);
          alert('An error occurred while trying to transcribe the audio.');
        }
      };
    }

    async function sendToOpenAI(transcription) {
      const openaiApiKey = window.NEXT_PUBLIC_OPENAI_API_KEY;  // Use the environment variable
      const url = 'https://api.openai.com/v1/completions';

      const requestPayload = {
        model: 'text-davinci-004',
        prompt: `User said: "${transcription}". Provide an appropriate response:`,
        max_tokens: 150
      };

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${openaiApiKey}`
          },
          body: JSON.stringify(requestPayload)
        });

        const data = await response.json();
        if (data && data.choices && data.choices[0]) {
          const aiResponse = data.choices[0].text.trim();
          console.log("AI Response:", aiResponse);
          alert(`AI Response: ${aiResponse}`);
        } else {
          console.error("No response from OpenAI");
          alert('No response from OpenAI');
        }
      } catch (error) {
        console.error('Error with OpenAI API:', error);
        alert('An error occurred while trying to get a response from OpenAI.');
      }
    }
  </script>

</body>
</html>